import{r as d,b as te,j as n}from"./app-BSOlzI_M.js";import{B as R}from"./button-D2rKFPK1.js";import{D as re,a as se,b as oe}from"./drawer-B6ZRXvIZ.js";import{ApplicantInformationFields as ne}from"./ApplicantInformationFields-BuIa63ve.js";import{AttachmentField as ie}from"./AttachmentField-BIIo1_ba.js";import{CityPropertyUnitSelector as ae}from"./CityPropertyUnitSelector-DiN1qhn-.js";import{CurrentSelectionDisplay as me}from"./CurrentSelectionDisplay-CjpfeO3m.js";import{StageAndNotesFields as de}from"./StageAndNotesFields-BqAJ14WZ.js";import{StatusAndDateFields as ce}from"./StatusAndDateFields-C7X8bVtm.js";import{i as U,f as F}from"./format-PYUiRpxY.js";import{p as le}from"./calendar-Di5dbzoO.js";import"./app-D9zByHv3.js";import"./index-ByB7CnZO.js";import"./index-CdJFUDDL.js";import"./utils-CBfrqCZ4.js";import"./index-09CEhTtY.js";import"./index-BK07_5Wa.js";import"./index-C5g_kYK6.js";import"./index-DIXGfQsU.js";import"./index-BLt4aHaa.js";import"./index-Eh5rTZKr.js";import"./x-V2a7Zg3Q.js";import"./createLucideIcon-BGWKpKjb.js";import"./input-DWv8_Yxn.js";import"./label-ku6Bo0xE.js";import"./select-Ckv1zRlQ.js";import"./index-Dc_FVRD7.js";import"./index-p7EaCzMM.js";import"./index-CJ72cHre.js";import"./index-C4PIvpnm.js";import"./index-C4dPa-2_.js";import"./chevron-down--Oeingn_.js";import"./check-BE4k6INO.js";import"./chevron-up-RzjEL1k0.js";import"./application-CnwOiERd.js";import"./file-text-XuiuEW0Z.js";import"./rotate-ccw-B0RGZt2F.js";import"./popover-CKsI89_0.js";import"./command-CBR154ui.js";import"./search-BcNZ_u8M.js";import"./chevrons-up-down-D-iRWSMZ.js";import"./radioGroup-DqEJ_5sj.js";import"./calendar-CthI5zTo.js";import"./chevron-left-CVo-4b8C.js";import"./chevron-right-DU-yjHU5.js";function st({application:r,cities:M,properties:c,units:l,open:f,onOpenChange:A,onSuccess:k,currentFilters:_,perPage:V="15",page:B=1}){const[I,a]=d.useState({}),[S,j]=d.useState(r.selected_city_id||null),[N,x]=d.useState(r.selected_property_id||null),[L,b]=d.useState([]),[z,h]=d.useState([]),[y,p]=d.useState([]),[C,u]=d.useState([]),w=t=>{if(!t)return"";const e=t.trim();if(!e||e==="0000-00-00")return"";try{const s=/^(\d{4})-(\d{2})-(\d{2})/.exec(e);if(s){const[,v,Z,ee]=s,E=new Date(Number(v),Number(Z)-1,Number(ee));if(U(E))return F(E,"yyyy-MM-dd")}const m=le(e,"yyyy-MM-dd",new Date(2e3,0,1));return U(m)?F(m,"yyyy-MM-dd"):""}catch(s){return console.warn("Date parsing error:",s),""}},{data:i,setData:o,post:$,processing:D,errors:g,transform:q}=te({unit_id:r.unit_id,name:r.name||"",co_signer:r.co_signer??"",status:r.status||"New",applicant_applied_from:r.applicant_applied_from??"",date:w(r.date),stage_in_progress:r.stage_in_progress||"",notes:r.notes||"",attachments:[],removed_attachment_indices:[]}),G=()=>{let t=r.selected_property_id??null,e=r.selected_city_id??null;if((!t||isNaN(t))&&r.unit_id){for(const[s,m]of Object.entries(l||{}))if(m?.some(v=>v.id===r.unit_id)){t=parseInt(s,10);break}}if((!e||isNaN(e))&&t){for(const[s,m]of Object.entries(c||{}))if(m?.some(v=>v.id===t)){e=parseInt(s,10);break}}return{cityId:e??null,propertyId:t??null}};d.useEffect(()=>{if(r&&f){const{cityId:t,propertyId:e}=G();j(t),x(e),p([]),u([]),t&&c[t]?b(c[t]):b([]),e&&l[e]?h(l[e]):h([]),o({unit_id:r.unit_id,name:r.name||"",co_signer:r.co_signer??"",status:r.status||"New",applicant_applied_from:r.applicant_applied_from??"",date:w(r.date),stage_in_progress:r.stage_in_progress||"",notes:r.notes||"",attachments:[],removed_attachment_indices:[]})}},[r,f,c,l]),d.useEffect(()=>{f||(a({}),p([]),u([]))},[f]);const H=t=>{const e=parseInt(t);j(e),x(null),o("unit_id",null),a(s=>({...s,city:void 0,property:void 0,unit:void 0})),c[e]?b(c[e]):b([]),h([])},J=t=>{const e=parseInt(t);x(e),o("unit_id",null),a(s=>({...s,property:void 0,unit:void 0})),l[e]?h(l[e]):h([])},K=t=>{const e=parseInt(t);o("unit_id",e),a(s=>({...s,unit:void 0}))},O=t=>{if(!y.includes(t)){const e=[...y,t];p(e),o("removed_attachment_indices",e)}},Q=t=>{const e=y.filter(s=>s!==t);p(e),o("removed_attachment_indices",e)},T=t=>{const e=[...C,...t];u(e),o("attachments",e)},W=t=>{const e=C.filter((s,m)=>m!==t);u(e),o("attachments",e)},P=t=>{t.preventDefault(),a({});let e=!1;const s={};if(S||(s.city="Please select a city before submitting the form.",e=!0),N||(s.property="Please select a property before submitting the form.",e=!0),i.unit_id||(s.unit="Please select a unit before submitting the form.",e=!0),(!i.name||i.name.trim()==="")&&(s.name="Please enter a name before submitting the form.",e=!0),(!i.status||i.status.trim()==="")&&(s.status="Please select a status before submitting the form.",e=!0),e){a(s);return}q(m=>({...m,_method:"put",filter_city:_?.city||"",filter_property:_?.property||"",filter_unit:_?.unit||"",filter_name:_?.name||"",filter_applicant_applied_from:_?.applicant_applied_from||"",per_page:V,page:B})),$(route("applications.update",r.id),{forceFormData:!0,preserveState:!0,preserveScroll:!0,onSuccess:()=>{a({}),u([]),p([]),A(!1),k?.()},onError:()=>console.error("Update failed")})},X=()=>{a({}),p([]),u([]),A(!1)},Y=(r.attachments||[]).filter((t,e)=>!y.includes(e));return n.jsx(re,{open:f,onOpenChange:A,modal:!1,children:n.jsx(se,{size:"half",title:`Edit Application - ${r.name}`,children:n.jsxs("div",{className:"flex h-full flex-col",children:[n.jsx("div",{className:"flex-1 overflow-auto p-6",children:n.jsxs("form",{onSubmit:P,className:"space-y-4",children:[n.jsx(ae,{cities:M,selectedCityId:S,selectedPropertyId:N,selectedUnitId:i.unit_id,availableProperties:L,availableUnits:z,onCityChange:H,onPropertyChange:J,onUnitChange:K,errors:g,validationErrors:I}),n.jsx(me,{city:r.city,property:r.property,unitName:r.unit_name}),n.jsx(ne,{name:i.name,coSigner:i.co_signer,applicantAppliedFrom:i.applicant_applied_from,onNameChange:t=>{o("name",t),a(e=>({...e,name:void 0}))},onCoSignerChange:t=>{o("co_signer",t)},onApplicantAppliedFromChange:t=>{o("applicant_applied_from",t)},errors:g,validationErrors:I}),n.jsx(ce,{status:i.status,date:i.date,onStatusChange:t=>{o("status",t),a(e=>({...e,status:void 0}))},onDateChange:t=>o("date",t),errors:g,validationErrors:I}),n.jsx(de,{stageInProgress:i.stage_in_progress,notes:i.notes,onStageChange:t=>o("stage_in_progress",t),onNotesChange:t=>o("notes",t),errors:g}),n.jsx(ie,{currentAttachments:Y,allAttachments:r.attachments,removedAttachmentIndices:y,newAttachments:C,onRemoveAttachment:O,onUndoRemoveAttachment:Q,onAddAttachments:T,onRemoveNewAttachment:W,errors:g})]})}),n.jsx(oe,{children:n.jsxs("div",{className:"flex justify-end gap-2",children:[n.jsx(R,{type:"button",variant:"outline",onClick:X,children:"Cancel"}),n.jsx(R,{type:"submit",disabled:D,onClick:P,children:D?"Updatingâ€¦":"Update Application"})]})})]})})})}export{st as default};
