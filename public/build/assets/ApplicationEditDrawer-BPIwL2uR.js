import{r as m,b as K,j as o}from"./app-ouZqxB1_.js";import{B as F}from"./button-Dwk07ddD.js";import{D as O,a as Q,b as W}from"./drawer-By3Utn4a.js";import{ApplicantInformationFields as X}from"./ApplicantInformationFields-DkPK2BR3.js";import{AttachmentField as Y}from"./AttachmentField-CfPmujbO.js";import{CityPropertyUnitSelector as Z}from"./CityPropertyUnitSelector-D9X7-L06.js";import{CurrentSelectionDisplay as ee}from"./CurrentSelectionDisplay-BQJ_6Axt.js";import{StageAndNotesFields as te}from"./StageAndNotesFields-BRsYWBBF.js";import{StatusAndDateFields as se}from"./StatusAndDateFields-DGoNzEDQ.js";import{f as re}from"./format-PYUiRpxY.js";import"./app-CsCti_B1.js";import"./index-ChCgVrQ9.js";import"./index-CdJFUDDL.js";import"./utils-CBfrqCZ4.js";import"./index-D_5cRLds.js";import"./index-CBrQgTKF.js";import"./index-DZ6Q_eM6.js";import"./index-B409lPMy.js";import"./index-Cw-58lmC.js";import"./index-L_KZmfdx.js";import"./x-C6lwu6z7.js";import"./createLucideIcon-D2D4_K7R.js";import"./input-Be-glciT.js";import"./label-DuRYAP1m.js";import"./select-CiYdqFJh.js";import"./index-Dc_FVRD7.js";import"./index-XAL2DKQ_.js";import"./index-BMcOUver.js";import"./index-D8RbbIhn.js";import"./index-DfGrYlP0.js";import"./chevron-down-DJ1Ff5Fx.js";import"./check-Ef_HP5Pc.js";import"./chevron-up-BPU5s7__.js";import"./application-CnwOiERd.js";import"./file-text-BT_oga12.js";import"./rotate-ccw-h4HMo2vS.js";import"./calendar-CiekVgOK.js";import"./chevron-left-B6urspn_.js";import"./chevron-right-DK0aPss0.js";import"./popover-HByMxBFn.js";import"./radioGroup-CiiMMFfa.js";import"./calendar-Bep_gocc.js";function Je({application:s,cities:P,properties:c,units:l,open:p,onOpenChange:v,onSuccess:E}){const[A,a]=m.useState({}),[x,j]=m.useState(s.selected_city_id||null),[S,I]=m.useState(s.selected_property_id||null),[R,y]=m.useState([]),[U,h]=m.useState([]),[_,u]=m.useState([]),[b,f]=m.useState([]),N=t=>{if(!t||t.trim()==="")return"";try{const e=new Date(t);return e&&!isNaN(e.getTime())?re(e,"yyyy-MM-dd"):""}catch(e){return console.warn("Date parsing error:",e),""}},{data:i,setData:n,post:k,processing:w,errors:g,transform:V}=K({unit_id:s.unit_id,name:s.name||"",co_signer:s.co_signer??"",status:s.status||"New",applicant_applied_from:s.applicant_applied_from??"",date:N(s.date),stage_in_progress:s.stage_in_progress||"",notes:s.notes||"",attachments:[],removed_attachment_indices:[]}),B=()=>{let t=s.selected_property_id??null,e=s.selected_city_id??null;if((!t||isNaN(t))&&s.unit_id){for(const[r,d]of Object.entries(l||{}))if(d?.some(C=>C.id===s.unit_id)){t=parseInt(r,10);break}}if((!e||isNaN(e))&&t){for(const[r,d]of Object.entries(c||{}))if(d?.some(C=>C.id===t)){e=parseInt(r,10);break}}return{cityId:e??null,propertyId:t??null}};m.useEffect(()=>{if(s&&p){const{cityId:t,propertyId:e}=B();j(t),I(e),u([]),f([]),t&&c[t]?y(c[t]):y([]),e&&l[e]?h(l[e]):h([]),n({unit_id:s.unit_id,name:s.name||"",co_signer:s.co_signer??"",status:s.status||"New",applicant_applied_from:s.applicant_applied_from??"",date:N(s.date),stage_in_progress:s.stage_in_progress||"",notes:s.notes||"",attachments:[],removed_attachment_indices:[]})}},[s,p,c,l]),m.useEffect(()=>{p||(a({}),u([]),f([]))},[p]);const L=t=>{const e=parseInt(t);j(e),I(null),n("unit_id",null),a(r=>({...r,city:void 0,property:void 0,unit:void 0})),c[e]?y(c[e]):y([]),h([])},M=t=>{const e=parseInt(t);I(e),n("unit_id",null),a(r=>({...r,property:void 0,unit:void 0})),l[e]?h(l[e]):h([])},z=t=>{const e=parseInt(t);n("unit_id",e),a(r=>({...r,unit:void 0}))},T=t=>{if(!_.includes(t)){const e=[..._,t];u(e),n("removed_attachment_indices",e)}},$=t=>{const e=_.filter(r=>r!==t);u(e),n("removed_attachment_indices",e)},q=t=>{const e=[...b,...t];f(e),n("attachments",e)},G=t=>{const e=b.filter((r,d)=>d!==t);f(e),n("attachments",e)},D=t=>{t.preventDefault(),a({});let e=!1;const r={};if(x||(r.city="Please select a city before submitting the form.",e=!0),S||(r.property="Please select a property before submitting the form.",e=!0),i.unit_id||(r.unit="Please select a unit before submitting the form.",e=!0),(!i.name||i.name.trim()==="")&&(r.name="Please enter a name before submitting the form.",e=!0),(!i.status||i.status.trim()==="")&&(r.status="Please select a status before submitting the form.",e=!0),e){a(r);return}V(d=>({...d,_method:"put"})),k(route("applications.update",s.id),{forceFormData:!0,onSuccess:()=>{a({}),f([]),u([]),v(!1),E?.()},onError:()=>console.error("Update failed")})},H=()=>{a({}),u([]),f([]),v(!1)},J=(s.attachments||[]).filter((t,e)=>!_.includes(e));return o.jsx(O,{open:p,onOpenChange:v,modal:!1,children:o.jsx(Q,{size:"half",title:`Edit Application - ${s.name}`,children:o.jsxs("div",{className:"flex h-full flex-col",children:[o.jsx("div",{className:"flex-1 overflow-auto p-6",children:o.jsxs("form",{onSubmit:D,className:"space-y-4",children:[o.jsx(Z,{cities:P,selectedCityId:x,selectedPropertyId:S,selectedUnitId:i.unit_id,availableProperties:R,availableUnits:U,onCityChange:L,onPropertyChange:M,onUnitChange:z,errors:g,validationErrors:A}),o.jsx(ee,{city:s.city,property:s.property,unitName:s.unit_name}),o.jsx(X,{name:i.name,coSigner:i.co_signer,applicantAppliedFrom:i.applicant_applied_from,onNameChange:t=>{n("name",t),a(e=>({...e,name:void 0}))},onCoSignerChange:t=>{n("co_signer",t)},onApplicantAppliedFromChange:t=>{n("applicant_applied_from",t)},errors:g,validationErrors:A}),o.jsx(se,{status:i.status,date:i.date,onStatusChange:t=>{n("status",t),a(e=>({...e,status:void 0}))},onDateChange:t=>n("date",t),errors:g,validationErrors:A}),o.jsx(te,{stageInProgress:i.stage_in_progress,notes:i.notes,onStageChange:t=>n("stage_in_progress",t),onNotesChange:t=>n("notes",t),errors:g}),o.jsx(Y,{currentAttachments:J,allAttachments:s.attachments,removedAttachmentIndices:_,newAttachments:b,onRemoveAttachment:T,onUndoRemoveAttachment:$,onAddAttachments:q,onRemoveNewAttachment:G,errors:g})]})}),o.jsx(W,{children:o.jsxs("div",{className:"flex justify-end gap-2",children:[o.jsx(F,{type:"button",variant:"outline",onClick:H,children:"Cancel"}),o.jsx(F,{type:"submit",disabled:w,onClick:D,children:w?"Updatingâ€¦":"Update Application"})]})})]})})})}export{Je as default};
